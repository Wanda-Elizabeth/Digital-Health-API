# .env.example - copy to .env and edit as needed
DB_USER=postgres
DB_PASS=postgres
DB_HOST=db
DB_PORT=5432
DB_NAME=healthdb
# or set a full database url:
# DATABASE_URL=postgresql://postgres:postgres@db:5432/healthdb

tests/conftest.py
# tests/conftest.py
# Pytest fixtures to share TestClient and DB session.
import os
import time
import pytest
from fastapi.testclient import TestClient
from app.main import app
from app.database import engine
from app import models
from app.core.config import get_settings
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# Default: tests assume a Postgres DB is available and alembic has run migrations.
# When running tests, ensure docker-compose up -d db; then run migrations before pytest.

client = TestClient(app)

@pytest.fixture(scope="session", autouse=True)
def wait_for_db():
    """
    If you run tests immediately after starting the DB, there may be a short period
    before the DB accepts connections. This fixture retries briefly.
    """
    settings = get_settings()
    # retry loop
    from sqlalchemy import text
    engine_retry = create_engine(settings.DATABASE_URL)
    for _ in range(10):
        try:
            with engine_retry.connect() as conn:
                conn.execute(text("SELECT 1"))
            break
        except Exception:
            time.sleep(0.5)
    else:
        raise RuntimeError("Database not available for tests")
    # ensure tables are present (migrations should handle this); optional: create_all for safety
    models.Base.metadata.create_all(bind=engine)

    yield
